{% extends 'base.html.twig' %}

{% block title %}Mon activit√©
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h1 class="mb-0">
				Activit√© de :
				{{ utilisateur.prenom is not empty ? utilisateur.prenom : '' }}
				{{ utilisateur.nom is not empty ? utilisateur.nom : '' }}
				{% if utilisateur.prenom is empty and utilisateur.nom is empty %}
					{{ utilisateur.email }}
				{% endif %}
			</h1>
		</div>

		{# KPIs calcul√©s c√¥t√© Twig #}
		{% set total = tentatives|length %}
		{% set bestPct = 0 %}
		{% set sumPct = 0 %}
		{% set lastActivity = null %}
		{% for t in tentatives %}
			{% set pct = t.pourcentage ?? 0 %}
			{% if pct > bestPct %}
				{% set bestPct = pct %}
			{% endif %}
			{% set sumPct = sumPct + pct %}
			{% set d = t.dateFin ?: t.dateDebut %}
			{% if d is not null %}
				{% if lastActivity is null or d > lastActivity %}
					{% set lastActivity = d %}
				{% endif %}
			{% endif %}
		{% endfor %}
		{% set avgPct = total > 0 ? (sumPct / total) : 0 %}

		<div class="row g-3 mb-4">
			<div class="col-6 col-md-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-muted small">Quiz termin√©s</div>
						<div class="fs-3 fw-bold">{{ total }}</div>
					</div>
				</div>
			</div>
			<div class="col-6 col-md-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-muted small">Meilleur score</div>
						<div class="fs-3 fw-bold">{{ bestPct|number_format(0) }}%</div>
					</div>
				</div>
			</div>
			<div class="col-6 col-md-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-muted small">Moyenne</div>
						<div class="fs-3 fw-bold">{{ avgPct|number_format(0) }}%</div>
					</div>
				</div>
			</div>
			<div class="col-6 col-md-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-muted small">Derni√®re activit√©</div>
						<div class="fs-6 fw-semibold">{{ lastActivity ? (lastActivity|date('d/m/Y H:i')) : '‚Äî' }}</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row g-4 mb-3">
			<div class="col-lg-7">
				<h2 class="h5 mb-3">Historique r√©cent</h2>
				{% if tentatives is empty %}
					<div class="alert alert-info">Aucune activit√© r√©cente. Lance un quiz pour commencer.</div>
				{% else %}
					<div
						class="list-group">
						{# Affiche les 5 plus r√©centes "√† peu pr√®s" (ordre non garanti si non tri√© en base) #}
						{% set i = 0 %}
						{% for t in tentatives %}
							{% if i < 5 %}
								<div class="list-group-item d-flex justify-content-between align-items-center">
									<div>
										<div class="fw-semibold">
											{{ t.quiz ? t.quiz.titre : 'Quiz' }}
											{% if badges is defined and badges is not empty and t.quiz %}
												{% set hasBadge = (badges|filter(b => b.quiz and b.quiz.id == t.quiz.id))|length > 0 %}
												{% if hasBadge %}
													<span class="badge bg-success ms-2" title="Badge 80%">üèÖ</span>
												{% endif %}
											{% endif %}
										</div>
										<div class="text-muted small">Le
											{{ (t.dateFin ?? t.dateDebut)|date('d/m/Y H:i') }}</div>
									</div>
									<div class="text-end">
										<div class="fw-bold">{{ (t.pourcentage ?? 0)|number_format(0) }}%</div>
										{% if t.quiz %}
											<a class="btn btn-outline-turquoise btn-sm mt-1" href="{{ path('app_start_quiz', {'id': t.quiz.id}) }}">Rejouer</a>
										{% else %}
											<button class="btn btn-outline-secondary btn-sm mt-1" disabled>Rejouer</button>
										{% endif %}
									</div>
								</div>
								{% set i = i + 1 %}
							{% endif %}
						{% endfor %}
					</div>
				{% endif %}
			</div>

			<div class="col-lg-5">
				<h2 class="h5 mb-3">Objectifs</h2>
				<div class="card mb-3 shadow-sm">
				<div class="card-body">
					<table class="table table-sm align-middle mb-0">
					<tbody>
						<tr>
						<td class="fs-5" style="width:36px;">ü•á</td>
						<td>Badge Or</td>
						<td>100%</td>
						</tr>
						<tr>
						<td class="fs-5">ü•à</td>
						<td>Badge Argent</td>
						<td>80%+</td>
						</tr>
						<tr>
						<td class="fs-5">ü•â</td>
						<td>Badge Bronze</td>
						<td>50%+</td>
						</tr>
					</tbody>
					</table>
				</div>
				</div>
	

				<h2 class="h5 mb-3">Badges</h2>
				<div class="card shadow-sm">
					{% if badges is defined and badges is not empty %}
						<div
							class="card-body">
							{# R√©sum√© des badges #}
							{% set totalTentatives = tentatives|length %}
							{% set seenQuiz = {} %}
							{% for t in tentatives %}
								{% if t.quiz %}
									{% set seenQuiz = seenQuiz|merge({ (t.quiz.id): true }) %}
								{% endif %}
							{% endfor %}
							{% set distinctAttempted = seenQuiz|length %}

							{% set seenBadgeQuizzes = {} %}
							{% for b in badges %}
								{% if b.quiz %}
									{% set seenBadgeQuizzes = seenBadgeQuizzes|merge({ (b.quiz.id): true }) %}
								{% endif %}
							{% endfor %}
							{% set distinctBadgeQuizzes = seenBadgeQuizzes|length %}

							<div class="fw-semibold mb-1">
								Vous avez obtenu
								{{ badges|length }}
								{{ badges|length > 1 ? 'badges' : 'badge' }}
								pour
								{{ distinctBadgeQuizzes }}
								{{ distinctBadgeQuizzes > 1 ? 'quiz' : 'quiz' }}
								sur
								{{ distinctAttempted }}
								{{ distinctAttempted > 1 ? 'quiz jou√©s' : 'quiz jou√©' }}.
							</div>
							{# Comptage par type de badge #}
							{% set goldCount = 0 %}
							{% set silverCount = 0 %}
							{% set bronzeCount = 0 %}
							{% for b in badges %}
							{% set title = b.title|default('') %}
							{% if 'Or' in title or '100' in title %}
								{% set goldCount = goldCount + 1 %}
							{% elseif 'Argent' in title or '80' in title %}
								{% set silverCount = silverCount + 1 %}
							{% elseif 'Bronze' in title or '50' in title %}
								{% set bronzeCount = bronzeCount + 1 %}
							{% endif %}
							{% endfor %}

							{# Lignes de r√©sum√© par type (s‚Äôaffichent seulement si > 0) #}
							{% if goldCount > 0 %}
							<div>Vous avez obtenu {{ goldCount }} badge{{ goldCount > 1 ? 's' : '' }} Or ü•á.</div>
							{% endif %}
							{% if silverCount > 0 %}
							<div>Vous avez obtenu {{ silverCount }} badge{{ silverCount > 1 ? 's' : '' }} Argent ü•à.</div>
							{% endif %}
							{% if bronzeCount > 0 %}
							<div>Vous avez obtenu {{ bronzeCount }} badge{{ bronzeCount > 1 ? 's' : '' }} Bronze ü•â.</div>
							{% endif %}
							<div class="mt-2"></div>
						</div>
						

					{% else %}
						<div class="card-body text-muted">
							{% set totalTentatives = tentatives|length %}
							{% set seenQuiz = {} %}
							{% for t in tentatives %}
								{% if t.quiz %}
									{% set seenQuiz = seenQuiz|merge({ (t.quiz.id): true }) %}
								{% endif %}
							{% endfor %}
							{% set distinctAttempted = seenQuiz|length %}
							Aucun badge pour le moment. Vous avez obtenu 0 badge sur
							{{ distinctAttempted }}
							{{ distinctAttempted > 1 ? 'quiz jou√©s' : 'quiz jou√©' }}.
						</div>
					{% endif %}
				</div>
			</div>
		</div>

		<hr class="my-4">

		<h2 class="h5 mb-3 d-flex justify-content-between align-items-center">
		<span>Mes quiz effectu√©s</span>
		<button id="filterBadgeBtn" class="btn btn-outline-primary btn-sm">Voir tous mes quiz avec badge</button>
		</h2>
		{% set seen = {} %}

		{# Ensemble des quiz ayant au moins un badge #}
		{% set badgeQuizIdsSet = {} %}
		{% if badges is defined %}
		{% for b in badges %}
			{% if b.quiz %}
			{% set badgeQuizIdsSet = badgeQuizIdsSet|merge({ (b.quiz.id): true }) %}
			{% endif %}
		{% endfor %}
		{% endif %}
		<div class="row g-3">
			{% for t in tentatives %}
				{% if t.quiz and (seen[t.quiz.id] is not defined) %}
					{% set seen = seen|merge({ (t.quiz.id): true }) %}
					<div class="col-12 col-sm-6 col-lg-4">
						<div class="card h-100 shadow-sm">
							<div class="card-body d-flex flex-column">
								<div class="fw-semibold mb-1">{{ t.quiz.titre }}</div>
								<div class="text-muted small mb-2">Derni√®re fois:
									{{ (t.dateFin ?? t.dateDebut)|date('d/m/Y H:i') }}</div>

								<div class="mt-auto d-flex justify-content-between align-items-center">
									<span class="badge bg-primary">{{ (t.pourcentage ?? 0)|number_format(0) }}%</span>
									<a class="btn btn-outline-turquoise btn-sm" href="{{ path('app_start_quiz', {'id': t.quiz.id}) }}">Ouvrir</a>
								</div>
							</div>
						</div>
					</div>
				{% endif %}
			{% endfor %}
			{% if seen|length == 0 %}
				<div class="col-12">
					<div class="alert alert-info">Vous n'avez encore effectu√© aucun quiz.</div>
				</div>
			{% endif %}
		</div>


	</div>
{% endblock %}
