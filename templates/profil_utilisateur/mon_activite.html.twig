{% extends 'base.html.twig' %}

{% block title %}Mon activité
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h1 class="mb-0">
				Activité de :
				{{ utilisateur.prenom is not empty ? utilisateur.prenom : '' }}
				{{ utilisateur.nom is not empty ? utilisateur.nom : '' }}
				{% if utilisateur.prenom is empty and utilisateur.nom is empty %}
					{{ utilisateur.email }}
				{% endif %}
			</h1>
		</div>

		{# KPIs calculés côté Twig #}
		{% set total = tentatives|length %}
		{% set bestPct = 0 %}
		{% set sumPct = 0 %}
		{% set lastActivity = null %}
		{% for t in tentatives %}
			{% set pct = t.pourcentage ?? 0 %}
			{% if pct > bestPct %}
				{% set bestPct = pct %}
			{% endif %}
			{% set sumPct = sumPct + pct %}
			{% set d = t.dateFin ?: t.dateDebut %}
			{% if d is not null %}
				{% if lastActivity is null or d > lastActivity %}
					{% set lastActivity = d %}
				{% endif %}
			{% endif %}
		{% endfor %}
		{% set avgPct = total > 0 ? (sumPct / total) : 0 %}

		<div class="row g-4 mb-4">
			<div class="col-6 col-md-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-muted small">Quiz terminés</div>
						<div class="fs-3 fw-bold">{{ total }}</div>
					</div>
				</div>
			</div>
			<div class="col-6 col-md-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-muted small">Meilleur score</div>
						<div class="fs-3 fw-bold">{{ bestPct|number_format(0) }}%</div>
					</div>
				</div>
			</div>
			<div class="col-6 col-md-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-muted small">Moyenne</div>
						<div class="fs-3 fw-bold">{{ avgPct|number_format(0) }}%</div>
					</div>
				</div>
			</div>
			<div class="col-6 col-md-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-muted small">Dernière activité</div>
						<div class="fs-6 fw-semibold">{{ lastActivity ? (lastActivity|date('d/m/Y H:i')) : '—' }}</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row g-4 mb-4">
			<div class="col-lg-7">
				<h2 class="h5 fw-semibold mb-4">Historique</h2>
				{% if tentatives is empty %}
					<div class="alert alert-info">Aucune activité récente. Lance un quiz pour commencer.</div>
				{% else %}
					{% set tentativesSorted = tentatives|sort((a, b) => (((a.dateFin ?? a.dateDebut) < (b.dateFin ?? b.dateDebut)) ? 1 : -1)) %}
					<div class="list-group">
						{% for t in tentativesSorted %}
							<div class="list-group-item d-flex justify-content-between align-items-center py-3">
								<div>
									<div class="fw-semibold mb-1">
										{{ (t.quiz ? t.quiz.titre : 'Quiz')|replace({'#': ''}) }}
										{% if badges is defined and badges is not empty and t.quiz %}
											{% set matching = badges|filter(b => b.quiz and b.quiz.id == t.quiz.id) %}
											{% if matching|length > 0 %}
												{% set title = matching|first.title|default('') %}
												{% if 'Or' in title or '100' in title %}
													{% set icon = '&#129351;' %}
												{% elseif 'Argent' in title or '80' in title %}
													{% set icon = '&#129352;' %}
												{% elseif 'Bronze' in title or '50' in title %}
													{% set icon = '&#129353;' %}
												{% else %}
													{% set icon = '&#127941;' %}
												{% endif %}
												<span class="badge bg-success ms-2" title="{{ title|e }}">{{ icon|raw }}</span>
											{% endif %}
										{% endif %}
									</div>
									<div class="text-muted small">Le
										{{ (t.dateFin ?? t.dateDebut)|date('d/m/Y H:i') }}</div>
								</div>
								<div class="text-end">
									<div class="fw-bold">{{ (t.pourcentage ?? 0)|number_format(0) }}%</div>
									{% if t.quiz %}
										<a class="btn btn-outline-turquoise btn-sm mt-1" href="{{ path('app_start_quiz', {'id': t.quiz.id}) }}">Rejouer</a>
									{% else %}
										<button class="btn btn-outline-secondary btn-sm mt-1" disabled>Rejouer</button>
									{% endif %}
								</div>
							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>

			<div class="col-lg-5">
				<h2 class="h5 fw-semibold mb-4">Objectifs</h2>
				<div class="card mb-3 shadow-sm">
					<div class="card-body">
						<table class="table table-sm align-middle mb-0">
							<tbody>
								<tr>
									<td class="fs-5" style="width:36px;">&#129351;</td>
									<td>Badge Or</td>
									<td>100%</td>
								</tr>
								<tr>
									<td class="fs-5">&#129352;</td>
									<td>Badge Argent</td>
									<td>80%+</td>
								</tr>
								<tr>
									<td class="fs-5">&#129353;</td>
									<td>Badge Bronze</td>
									<td>50%+</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<h2 class="h5 fw-semibold mb-4">Badges</h2>
				<div class="card shadow-sm">
					{% if badges is defined and badges is not empty %}
						<div
							class="card-body">
							{# Résumé des badges #}
							{% set totalTentatives = tentatives|length %}
							{% set seenQuiz = {} %}
							{% for t in tentatives %}
								{% if t.quiz %}
									{% set seenQuiz = seenQuiz|merge({ (t.quiz.id): true }) %}
								{% endif %}
							{% endfor %}
							{% set distinctAttempted = seenQuiz|length %}

							{% set seenBadgeQuizzes = {} %}
							{% for b in badges %}
								{% if b.quiz %}
									{% set seenBadgeQuizzes = seenBadgeQuizzes|merge({ (b.quiz.id): true }) %}
								{% endif %}
							{% endfor %}
							{% set distinctBadgeQuizzes = seenBadgeQuizzes|length %}

							<div class="fw-semibold mb-1">
								Vous avez obtenu
								{{ badges|length }}
								{{ badges|length > 1 ? 'badges' : 'badge' }}
								pour
								{{ distinctBadgeQuizzes }}
								{{ distinctBadgeQuizzes > 1 ? 'quiz' : 'quiz' }}
								sur
								{{ distinctAttempted }}
								{{ distinctAttempted > 1 ? 'quiz joués' : 'quiz joué' }}.
							</div>
							{# Comptage par type de badge #}
							{% set goldCount = 0 %}
							{% set silverCount = 0 %}
							{% set bronzeCount = 0 %}
							{% for b in badges %}
								{% set title = b.title|default('') %}
								{% if 'Or' in title or '100' in title %}
									{% set goldCount = goldCount + 1 %}
								{% elseif 'Argent' in title or '80' in title %}
									{% set silverCount = silverCount + 1 %}
								{% elseif 'Bronze' in title or '50' in title %}
									{% set bronzeCount = bronzeCount + 1 %}
								{% endif %}
							{% endfor %}

							{# Lignes de résumé par type (s’affichent seulement si > 0) #}
							{% if goldCount > 0 %}
								<div>Vous avez obtenu
									{{ goldCount }}
									badge{{ goldCount > 1 ? 's' : '' }}
									Or &#129351;.</div>
							{% endif %}
							{% if silverCount > 0 %}
								<div>Vous avez obtenu
									{{ silverCount }}
									badge{{ silverCount > 1 ? 's' : '' }}
									Argent &#129352;.</div>
							{% endif %}
							{% if bronzeCount > 0 %}
								<div>Vous avez obtenu
									{{ bronzeCount }}
									badge{{ bronzeCount > 1 ? 's' : '' }}
									Bronze &#129353;.</div>
							{% endif %}
							<div class="mt-2"></div>
						</div>
					{% else %}
						<div class="card-body text-muted">
							{% set totalTentatives = tentatives|length %}
							{% set seenQuiz = {} %}
							{% for t in tentatives %}
								{% if t.quiz %}
									{% set seenQuiz = seenQuiz|merge({ (t.quiz.id): true }) %}
								{% endif %}
							{% endfor %}
							{% set distinctAttempted = seenQuiz|length %}
							Aucun badge pour le moment. Vous avez obtenu 0 badge sur
							{{ distinctAttempted }}
							{{ distinctAttempted > 1 ? 'quiz joués' : 'quiz joué' }}.
						</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	
{% endblock %}
